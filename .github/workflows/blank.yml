name: Win-RDP-Zrok-Auto

on: 
  workflow_dispatch:

jobs:
  zrok-session:
    runs-on: windows-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup User & RDP Configuration
      shell: pwsh
      run: |
        # 1. إعداد المستخدم
        $password = ConvertTo-SecureString "Admin@12345" -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $password

        # 2. تفعيل RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -value 1
        
        # 3. منع قفل الشاشة
        Set-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System' -Name "InactivityTimeoutSecs" -Value 0 -Force

    - name: Install & Configure Zrok (Auto-Latest)
      shell: pwsh
      env:
        ZROK_TOKEN: ${{ secrets.ZROK_TOKEN }}
      run: |
        Write-Host "Finding latest Zrok version..."
        
        # جلب معلومات أحدث إصدار تلقائياً من GitHub API
        $latest = Invoke-RestMethod -Uri "https://api.github.com/repos/openziti/zrok/releases/latest"
        $tag = $latest.tag_name           # مثال: v0.4.45
        $ver = $tag.TrimStart('v')        # مثال: 0.4.45
        
        # تكوين رابط التحميل بناءً على أحدث إصدار
        $url = "https://github.com/openziti/zrok/releases/download/$tag/zrok_${ver}_windows_amd64.zip"
        
        Write-Host "Downloading version $tag from $url"
        Invoke-WebRequest $url -OutFile "zrok.zip"
        
        # فك الضغط
        Expand-Archive zrok.zip -DestinationPath .
        
        # البحث عن ملف zrok.exe ونقله (لأن اسم المجلد يتغير مع كل إصدار)
        $zrokPath = Get-ChildItem -Path . -Recurse -Filter "zrok.exe" | Select-Object -First 1
        Move-Item -Path $zrokPath.FullName -Destination "$env:USERPROFILE\zrok.exe"
        
        # تفعيل الحساب
        & "$env:USERPROFILE\zrok.exe" enable $env:ZROK_TOKEN
        Write-Host "Zrok Enabled Successfully!"

    - name: Start Zrok Tunnel & Show Link
      shell: pwsh
      run: |
        Write-Host "Starting Zrok Tunnel..."
        
        # تشغيل النفق
        $proc = Start-Process -FilePath "$env:USERPROFILE\zrok.exe" -ArgumentList "share public 127.0.0.1:3389 --backend-mode tcpTunnel --headless" -PassThru -RedirectStandardOutput "$env:USERPROFILE\zrok_log.txt"
        
        Start-Sleep -Seconds 15
        
        # استخراج الرابط
        $logContent = Get-Content "$env:USERPROFILE\zrok_log.txt"
        $urlLine = $logContent | Select-String "tcp://"
        
        Write-Host "=============================================" -ForegroundColor Green
        if ($urlLine) {
            Write-Host "YOUR RDP ADDRESS IS:" -ForegroundColor Cyan
            $cleanUrl = $urlLine.ToString().Split(" ")[-1]
            Write-Host $cleanUrl -ForegroundColor Yellow
        } else {
            Write-Host "Error finding URL. Log output:" -ForegroundColor Red
            Get-Content "$env:USERPROFILE\zrok_log.txt"
        }
        Write-Host "User: runneradmin"
        Write-Host "Pass: Admin@12345"
        Write-Host "============================================="

    - name: Keep Alive
      shell: pwsh
      run: |
        while ($true) {
          Start-Sleep -Seconds 300
        }
