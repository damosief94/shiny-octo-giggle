name: Win-Final-Snapshot

on:
  workflow_dispatch:

jobs:
  rdp-session:
    runs-on: windows-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    # 1. إعداد وتفعيل RDP
    - name: Enable Remote Desktop
      shell: pwsh
      run: |
        Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" fDenyTSConnections 0
        New-NetFirewallRule -DisplayName "Allow RDP" -Direction Inbound -LocalPort 3389 -Protocol TCP -Action Allow
        Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" UserAuthentication 1
        $password = ConvertTo-SecureString "Admin@12345" -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $password

    # 2. تشغيل Cloudflare + استخراج البورت بطريقة "النسخ اللحظي"
    - name: Start Tunnel & Get Port
      shell: pwsh
      run: |
        Write-Host "Downloading Cloudflare..."
        Invoke-WebRequest https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe
        
        Write-Host "Starting Tunnel..."
        # نجبر Cloudflare على الكتابة في ملف سجل
        $args = "tunnel --url tcp://localhost:3389 --logfile cloudflared.log"
        Start-Process -FilePath ".\cloudflared.exe" -ArgumentList $args -WindowStyle Hidden

        Write-Host "Waiting for connection..."
        Start-Sleep -Seconds 10
        
        $urlFound = $false
        $retryCount = 0
        
        # حلقة البحث (لمدة دقيقة ونصف)
        while ($retryCount -lt 90) {
            # الحيلة الذكية: نسخ الملف لقراءته ثم حذفه (تجاوز مشكلة قفل الملفات)
            if (Test-Path "cloudflared.log") {
                Copy-Item "cloudflared.log" "temp_read.log" -Force
                
                if (Test-Path "temp_read.log") {
                    $logContent = Get-Content "temp_read.log" -Raw
                    
                    # البحث عن الرابط الكامل (tcp://domain:port)
                    if ($logContent -match "tcp://[-a-zA-Z0-9.]+\.trycloudflare\.com:[0-9]+") {
                        $fullUrl = $matches[0]
                        $cleanUrl = $fullUrl -replace "tcp://", ""
                        
                        # فصل الرابط عن البورت
                        $parts = $cleanUrl -split ":"
                        $hostUrl = $parts[0]
                        $portNum = $parts[1]

                        Write-Host "=============================================" -ForegroundColor Green
                        Write-Host "        SUCCESS! Tunnel is Active            " -ForegroundColor Green
                        Write-Host "=============================================" -ForegroundColor Green
                        Write-Host " HOST:         $hostUrl " -ForegroundColor Cyan
                        Write-Host " PORT:         $portNum " -ForegroundColor Magenta
                        Write-Host " "
                        Write-Host " USERNAME:     runneradmin " -ForegroundColor Yellow
                        Write-Host " PASSWORD:     Admin@12345 " -ForegroundColor Yellow
                        Write-Host "=============================================" -ForegroundColor Green
                        
                        $urlFound = $true
                        # تنظيف الملف المؤقت قبل الخروج
                        Remove-Item "temp_read.log" -Force
                        break
                    }
                    # تنظيف الملف المؤقت
                    Remove-Item "temp_read.log" -Force
                }
            }
            
            Write-Host -NoNewline "."
            Start-Sleep -Seconds 1
            $retryCount++
        }

        if (-not $urlFound) {
            Write-Error "Could not find URL in logs."
            if (Test-Path "cloudflared.log") { Get-Content "cloudflared.log" }
            exit 1
        }

    # 3. إبقاء الجلسة حية
    - name: Keep Session Alive
      shell: pwsh
      run: |
        Write-Host "Session is active. Press Cancel to stop."
        while ($true) {
          Start-Sleep -Seconds 60
          Write-Host -NoNewline "."
        }
