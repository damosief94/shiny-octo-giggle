name: Win-RDP-Zrok

on: 
  workflow_dispatch:

jobs:
  zrok-session:
    runs-on: windows-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup User & RDP Configuration
      shell: pwsh
      run: |
        # 1. تعيين كلمة المرور (يمكنك تغيير Admin@12345)
        $password = ConvertTo-SecureString "Admin@12345" -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $password

        # 2. تفعيل RDP وفتح الجدار الناري
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -value 1
        
        # 3. منع قفل الشاشة عند الخمول
        Set-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System' -Name "InactivityTimeoutSecs" -Value 0 -Force

    - name: Install & Configure Zrok
      shell: pwsh
      env:
        ZROK_TOKEN: ${{ secrets.ZROK_TOKEN }}
      run: |
        # تحميل Zrok
        Write-Host "Downloading Zrok..."
        Invoke-WebRequest "https://github.com/openziti/zrok/releases/download/v0.4.23/zrok_0.4.23_windows_amd64.zip" -OutFile "zrok.zip"
        Expand-Archive zrok.zip -DestinationPath .
        
        # نقل الملف لمكان سهل
        Move-Item -Path ".\zrok_0.4.23_windows_amd64\zrok.exe" -Destination "$env:USERPROFILE\zrok.exe"
        
        # تفعيل الحساب
        & "$env:USERPROFILE\zrok.exe" enable $env:ZROK_TOKEN
        Write-Host "Zrok Enabled Successfully!"

    - name: Start Zrok Tunnel & Show Link
      shell: pwsh
      run: |
        Write-Host "Starting Zrok Tunnel..."
        
        # تشغيل النفق في الخلفية وتسجيل الرابط في ملف
        $proc = Start-Process -FilePath "$env:USERPROFILE\zrok.exe" -ArgumentList "share public 127.0.0.1:3389 --backend-mode tcpTunnel --headless" -PassThru -RedirectStandardOutput "$env:USERPROFILE\zrok_log.txt"
        
        # الانتظار قليلاً حتى يتم إنشاء الرابط
        Start-Sleep -Seconds 10
        
        # قراءة الملف واستخراج الرابط
        $logContent = Get-Content "$env:USERPROFILE\zrok_log.txt"
        $urlLine = $logContent | Select-String "tcp://"
        
        Write-Host "=============================================" -ForegroundColor Green
        if ($urlLine) {
            Write-Host "YOUR RDP ADDRESS IS:" -ForegroundColor Cyan
            # تنظيف الرابط ليظهر بشكل نظيف
            $cleanUrl = $urlLine.ToString().Split(" ")[-1]
            Write-Host $cleanUrl -ForegroundColor Yellow
        } else {
            Write-Host "Could not fetch URL instantly. Please check the logs below or wait." -ForegroundColor Red
            Write-Host "Raw Log Output:"
            Get-Content "$env:USERPROFILE\zrok_log.txt"
        }
        Write-Host "User: runneradmin"
        Write-Host "Pass: Admin@12345"
        Write-Host "============================================="

    - name: Keep Alive
      shell: pwsh
      run: |
        while ($true) {
          Start-Sleep -Seconds 300
        }
