name: Win-Pinggy-Memory

on:
  workflow_dispatch:

jobs:
  rdp-session:
    runs-on: windows-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    # 1. إعداد وتفعيل RDP
    - name: Enable Remote Desktop
      shell: pwsh
      run: |
        Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" fDenyTSConnections 0
        New-NetFirewallRule -DisplayName "Allow RDP" -Direction Inbound -LocalPort 3389 -Protocol TCP -Action Allow
        Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" UserAuthentication 1
        $password = ConvertTo-SecureString "Admin@12345" -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $password

    # 2. تشغيل Pinggy باستخدام الذاكرة (Memory Job) - الحل النهائي
    - name: Start Tunnel & Get URL
      shell: pwsh
      run: |
        Write-Host "Starting SSH Tunnel to Pinggy (Job Mode)..."
        
        # إنشاء وظيفة في الخلفية (Job) وتشغيل SSH داخلها
        # الرمز 2>&1 يضمن التقاط كل النصوص سواء كانت أخطاء أو مخرجات
        $job = Start-Job -ScriptBlock {
            ssh -o StrictHostKeyChecking=no -p 443 -R0:localhost:3389 tcp@a.pinggy.io 2>&1
        }

        $urlFound = $false
        
        # حلقة بحث لمدة 30 ثانية
        for ($i = 0; $i -lt 30; $i++) {
            Start-Sleep -Seconds 2
            
            # قراءة المخرجات من الذاكرة مباشرة (بدون ملفات)
            $output = Receive-Job -Job $job -Keep | Out-String
            
            # البحث عن الرابط
            if ($output -match "tcp://[a-zA-Z0-9\.-]+:[0-9]+") {
                $rawUrl = $matches[0]
                $cleanUrl = $rawUrl -replace "tcp://", ""
                
                Write-Host "=============================================" -ForegroundColor Green
                Write-Host " SUCCESS! Tunnel is Ready " -ForegroundColor Green
                Write-Host "=============================================" -ForegroundColor Green
                Write-Host " RDP ADDRESS:  $cleanUrl " -ForegroundColor Magenta
                Write-Host " USERNAME:     runneradmin " -ForegroundColor Yellow
                Write-Host " PASSWORD:     Admin@12345 " -ForegroundColor Yellow
                Write-Host "=============================================" -ForegroundColor Green
                
                $urlFound = $true
                break
            }
        }

        if (-not $urlFound) {
            Write-Error "Failed to find URL. Dumping raw output from memory:"
            Receive-Job -Job $job -Keep | Out-String
            exit 1
        }

    # 3. إبقاء الجلسة حية
    - name: Keep Session Alive
      shell: pwsh
      run: |
        Write-Host "Session is active. Press Cancel to stop."
        while ($true) {
          Start-Sleep -Seconds 60
          Write-Host -NoNewline "."
        }
