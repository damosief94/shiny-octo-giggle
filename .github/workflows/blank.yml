name: Win-Final-CMD-Fix

on:
  workflow_dispatch:

jobs:
  rdp-session:
    runs-on: windows-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    # 1. إعداد وتفعيل RDP
    - name: Enable Remote Desktop
      shell: pwsh
      run: |
        Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" fDenyTSConnections 0
        New-NetFirewallRule -DisplayName "Allow RDP" -Direction Inbound -LocalPort 3389 -Protocol TCP -Action Allow
        Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" UserAuthentication 1
        $password = ConvertTo-SecureString "Admin@12345" -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $password

    # 2. تشغيل Cloudflare (باستخدام CMD لضمان الكتابة الفورية)
    - name: Start Cloudflare Tunnel
      shell: cmd
      run: |
        curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -o cloudflared.exe
        echo Starting Tunnel...
        start /B cloudflared.exe tunnel --url tcp://localhost:3389 > tunnel.log 2>&1
        timeout /t 15

    # 3. قراءة الرابط وفصل البورت (باستخدام PowerShell)
    - name: Get Host and Port
      shell: pwsh
      run: |
        $urlFound = $false
        $retryCount = 0
        
        while ($retryCount -lt 30) {
            if (Test-Path "tunnel.log") {
                # قراءة الملف (حتى لو كان مفتوحاً)
                $stream = [System.IO.File]::Open("tunnel.log", [System.IO.FileMode]::Open, [System.IO.FileAccess]::Read, [System.IO.FileShare]::ReadWrite)
                $reader = New-Object System.IO.StreamReader($stream)
                $logContent = $reader.ReadToEnd()
                $reader.Close()
                $stream.Close()

                # البحث عن الرابط بصيغة tcp://url:port
                if ($logContent -match "tcp://([-a-zA-Z0-9]+\.trycloudflare\.com):([0-9]+)") {
                    $hostUrl = $matches[1]
                    $portNum = $matches[2]

                    Write-Host "=============================================" -ForegroundColor Green
                    Write-Host "       SUCCESS! Tunnel is Active             " -ForegroundColor Green
                    Write-Host "=============================================" -ForegroundColor Green
                    Write-Host " HOST:         $hostUrl " -ForegroundColor Cyan
                    Write-Host " PORT:         $portNum " -ForegroundColor Magenta
                    Write-Host " "
                    Write-Host " USERNAME:     runneradmin " -ForegroundColor Yellow
                    Write-Host " PASSWORD:     Admin@12345 " -ForegroundColor Yellow
                    Write-Host "=============================================" -ForegroundColor Green
                    
                    $urlFound = $true
                    break
                }
            }
            Start-Sleep -Seconds 2
            $retryCount++
        }

        if (-not $urlFound) {
            Write-Error "Could not find URL. Showing raw logs:"
            if (Test-Path "tunnel.log") { Get-Content "tunnel.log" }
            exit 1
        }

    # 4. إبقاء الجلسة حية
    - name: Keep Session Alive
      shell: pwsh
      run: |
        Write-Host "Session is active. Press Cancel to stop."
        while ($true) {
          Start-Sleep -Seconds 60
          Write-Host -NoNewline "."
        }
