name: Win-Final-Pinggy

on:
  workflow_dispatch:

jobs:
  rdp-session:
    runs-on: windows-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    # 1. إعداد وتفعيل RDP
    - name: Enable Remote Desktop
      shell: pwsh
      run: |
        Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" fDenyTSConnections 0
        New-NetFirewallRule -DisplayName "Allow RDP" -Direction Inbound -LocalPort 3389 -Protocol TCP -Action Allow
        Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" UserAuthentication 1
        $password = ConvertTo-SecureString "Admin@12345" -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $password

    # 2. تشغيل Pinggy (تم فصل ملفات السجلات لتجنب الأخطاء السابقة)
    - name: Start Tunnel & Get Info
      shell: pwsh
      run: |
        Write-Host "Starting Pinggy Tunnel..."
        
        # الإصلاح: استخدام ملفين مختلفين للمخرجات والأخطاء لتجنب تضارب الملفات
        $sshArgs = "-o StrictHostKeyChecking=no -p 443 -R0:localhost:3389 tcp@a.pinggy.io"
        $proc = Start-Process -FilePath "ssh" -ArgumentList $sshArgs -RedirectStandardOutput "pinggy_out.txt" -RedirectStandardError "pinggy_err.txt" -PassThru -WindowStyle Hidden

        # انتظار 10 ثواني
        Start-Sleep -Seconds 10
        
        $urlFound = $false
        $retryCount = 0
        
        # حلقة البحث
        while ($retryCount -lt 30) {
            # دمج محتوى الملفين للبحث فيهما
            $logs = ""
            if (Test-Path "pinggy_out.txt") { $logs += Get-Content "pinggy_out.txt" -Raw -ErrorAction SilentlyContinue }
            if (Test-Path "pinggy_err.txt") { $logs += Get-Content "pinggy_err.txt" -Raw -ErrorAction SilentlyContinue }

            # البحث عن نمط الرابط tcp://url:port
            if ($logs -match "tcp://([a-zA-Z0-9\.-]+):([0-9]+)") {
                $hostUrl = $matches[1]
                $portNum = $matches[2]
                
                Write-Host "=============================================" -ForegroundColor Green
                Write-Host "       SUCCESS! Tunnel is Active             " -ForegroundColor Green
                Write-Host "=============================================" -ForegroundColor Green
                
                # طباعة البيانات منفصلة وواضحة
                Write-Host " HOST (COMPUTER):  $hostUrl " -ForegroundColor Cyan
                Write-Host " PORT:             $portNum " -ForegroundColor Magenta
                Write-Host " "
                Write-Host " USERNAME:         runneradmin " -ForegroundColor Yellow
                Write-Host " PASSWORD:         Admin@12345 " -ForegroundColor Yellow
                Write-Host "=============================================" -ForegroundColor Green
                
                $urlFound = $true
                break
            }
            
            Start-Sleep -Seconds 2
            $retryCount++
        }

        if (-not $urlFound) {
            Write-Error "Could not find URL. Logs content:"
            if (Test-Path "pinggy_out.txt") { Get-Content "pinggy_out.txt" }
            if (Test-Path "pinggy_err.txt") { Get-Content "pinggy_err.txt" }
            exit 1
        }

    # 3. إبقاء الجلسة حية
    - name: Keep Session Alive
      shell: pwsh
      run: |
        Write-Host "Session is active. Press Cancel to stop."
        while ($true) {
          Start-Sleep -Seconds 60
          Write-Host -NoNewline "."
        }
