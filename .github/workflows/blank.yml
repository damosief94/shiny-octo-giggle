name: Ultimate-Win-CRD

on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Download Chrome Installer
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://dl.google.com/chrome/install/latest/chrome_installer.exe" -OutFile "chrome_installer.exe"
          Start-Process -FilePath "chrome_installer.exe" -Args "/silent /install" -Wait

      - name: Download and Install CRD
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile "crd.msi"
          Start-Process -FilePath "msiexec.exe" -Args "/i crd.msi /quiet /qn" -Wait

      # ========================================================
      # Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªØ«Ø¨ÙŠØª Ø§Ù„ÙƒØ±Øª Ø§Ù„ÙˆÙ‡Ù…ÙŠ ÙˆØ§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©
      # ========================================================
      - name: Ultimate GPU Injection (Mesa3D System-Wide)
        shell: pwsh
        run: |
          Write-Host ">>> 1. Installing Virtual Display Driver..."
          Invoke-WebRequest -Uri "https://www.amyuni.com/downloads/usbmmidd_v2.zip" -OutFile "usbmmidd.zip"
          Expand-Archive "usbmmidd.zip" -DestinationPath "c:\usbmmidd"
          cd c:\usbmmidd
          & .\deviceinstaller64.exe install usbmmidd.inf usbmmidd
          & .\deviceinstaller64.exe enableidd 1
          Write-Host "âœ… Virtual Display Active."

          Write-Host ">>> 2. Downloading Mesa3D (Fake GPU)..."
          cd C:\
          # Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± Ù„Ù†Ø³Ø®Ø© Ù…Ø³ØªÙ‚Ø±Ø© Ù…Ù† Mesa3D MinGW
          Invoke-WebRequest -Uri "https://github.com/pal1000/mesa-dist-win/releases/download/23.1.9/mesa3d-23.1.9-release-mingw.7z" -OutFile "mesa.7z"
          7z x mesa.7z -oc:\mesa3d
          $MesaDll = "C:\mesa3d\x64\opengl32.dll"

          Write-Host ">>> 3. Injecting Mesa3D into System32..."
          $SysDll = "C:\Windows\System32\opengl32.dll"
          
          # ÙƒØ³Ø± Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙˆÙŠÙ†Ø¯ÙˆØ² Ø¹Ù† Ù…Ù„Ù Ø§Ù„Ù†Ø¸Ø§Ù… (Take Ownership)
          takeown /f $SysDll
          icacls $SysDll /grant "${Env:USERNAME}:F"
          
          # Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ
          Rename-Item -Path $SysDll -NewName "opengl32.bak" -Force
          Copy-Item -Path $MesaDll -Destination $SysDll -Force
          
          Write-Host "âœ… FAKE GPU INSTALLED IN SYSTEM32 SUCCESSFULLY!"
      # ========================================================
      # Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      # ========================================================

      - name: Start Chrome Remote Desktop
        shell: pwsh
        env:
          CRD_CODE: ${{ secrets.CRD_CODE }}
          CRD_PIN: ${{ secrets.CRD_PIN }}
        run: |
          $exePath = "${Env:PROGRAMFILES(X86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
          & $exePath --code="$env:CRD_CODE" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name=$Env:COMPUTERNAME --pin=$env:CRD_PIN

      - name: Success Message
        shell: pwsh
        run: |
          Write-Host "======================================================"
          Write-Host "âœ… The Server is RUNNING with FAKE GPU INJECTED!"
          Write-Host "ğŸ”— Go to: https://remotedesktop.google.com/access"
          Write-Host "ğŸ‘‰ Connect to the PC named 'WIN-...' using your PIN."
          Write-Host "======================================================"

      - name: Keep Alive
        shell: pwsh
        run: |
          while ($true) { Start-Sleep -Seconds 300 }
