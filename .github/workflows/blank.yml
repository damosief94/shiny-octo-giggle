name: Win-CF-API-Method

on:
  workflow_dispatch:

jobs:
  rdp-session:
    runs-on: windows-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    # 1. إعداد وتفعيل RDP
    - name: Enable Remote Desktop
      shell: pwsh
      run: |
        Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" fDenyTSConnections 0
        New-NetFirewallRule -DisplayName "Allow RDP" -Direction Inbound -LocalPort 3389 -Protocol TCP -Action Allow
        Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" UserAuthentication 1
        $password = ConvertTo-SecureString "Admin@12345" -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $password

    # 2. تشغيل Cloudflare + جلب الرابط عن طريق API (الطريقة المضمونة)
    - name: Start Tunnel & Get URL via API
      shell: pwsh
      run: |
        Write-Host "Downloading Cloudflare..."
        Invoke-WebRequest https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe
        
        Write-Host "Starting Cloudflare Tunnel..."
        
        # نشغل البرنامج ونطلب منه فتح منفذ خاص للمقاييس (Metrics) على 45678
        # هذا يسمح لنا بسحب الرابط مباشرة من النظام دون الحاجة لملفات
        $args = "tunnel --url tcp://localhost:3389 --metrics localhost:45678"
        Start-Process -FilePath ".\cloudflared.exe" -ArgumentList $args -WindowStyle Hidden

        # انتظار قليل
        Start-Sleep -Seconds 10
        
        $urlFound = $false
        $retryCount = 0
        
        # محاولة سحب الرابط من الـ API الداخلي
        while ($retryCount -lt 60) {
            try {
                # طلب المعلومات من Cloudflare مباشرة
                $response = Invoke-RestMethod -Uri "http://localhost:45678/quicktunnel" -ErrorAction Stop
                
                if ($response -and $response.hostname) {
                    $cleanUrl = $response.hostname
                    
                    Write-Host "=============================================" -ForegroundColor Green
                    Write-Host " CONNECT TO:   $cleanUrl " -ForegroundColor Yellow
                    Write-Host " USERNAME:     runneradmin " -ForegroundColor Yellow
                    Write-Host " PASSWORD:     Admin@12345 " -ForegroundColor Yellow
                    Write-Host "=============================================" -ForegroundColor Green
                    $urlFound = $true
                    break
                }
            }
            catch {
                # نتجاهل الأخطاء حتى يعمل السيرفر
            }
            
            Write-Host -NoNewline "."
            Start-Sleep -Seconds 2
            $retryCount++
        }

        if (-not $urlFound) {
            Write-Error "Failed to get URL via API. Check if cloudflared is running."
            exit 1
        }

        # حلقة إبقاء الجلسة حية
        Write-Host "Session is ready! Do not cancel this workflow."
        while ($true) {
            Start-Sleep -Seconds 60
            Write-Host -NoNewline "."
        }
