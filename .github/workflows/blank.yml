name: Win-Pinggy

on:
  workflow_dispatch:

jobs:
  rdp-session:
    runs-on: windows-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    # 1. إعداد وتفعيل RDP
    - name: Enable Remote Desktop
      shell: pwsh
      run: |
        Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" fDenyTSConnections 0
        New-NetFirewallRule -DisplayName "Allow RDP" -Direction Inbound -LocalPort 3389 -Protocol TCP -Action Allow
        Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" UserAuthentication 1
        $password = ConvertTo-SecureString "Admin@12345" -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $password

    # 2. تشغيل Pinggy عبر SSH (بدون تحميل برامج)
    - name: Start Pinggy Tunnel
      shell: pwsh
      run: |
        Write-Host "Starting SSH Tunnel to Pinggy..."
        
        # تشغيل SSH وتوجيه كل المخرجات لملف نصي
        # نستخدم tcp@a.pinggy.io للحصول على نفق TCP
        $proc = Start-Process -FilePath "ssh" -ArgumentList "-o StrictHostKeyChecking=no -p 443 -R0:localhost:3389 tcp@a.pinggy.io" -RedirectStandardOutput "pinggy.log" -RedirectStandardError "pinggy.log" -PassThru -WindowStyle Hidden

        # الانتظار قليلاً حتى يتم إنشاء الرابط
        Start-Sleep -Seconds 10

        $urlFound = $false
        $retryCount = 0

        while ($retryCount -lt 30) {
            if (Test-Path "pinggy.log") {
                $logContent = Get-Content "pinggy.log" -Raw
                # البحث عن الرابط بصيغة tcp://...
                if ($logContent -match "tcp://[a-z0-9\.-]+:[0-9]+") {
                    $rawUrl = $matches[0]
                    $cleanUrl = $rawUrl -replace "tcp://", ""
                    
                    Write-Host "=============================================" -ForegroundColor Green
                    Write-Host " CONNECT TO:   $cleanUrl " -ForegroundColor Yellow
                    Write-Host " USERNAME:     runneradmin " -ForegroundColor Yellow
                    Write-Host " PASSWORD:     Admin@12345 " -ForegroundColor Yellow
                    Write-Host "=============================================" -ForegroundColor Green
                    $urlFound = $true
                    break
                }
            }
            Write-Host -NoNewline "."
            Start-Sleep -Seconds 2
            $retryCount++
        }

        if (-not $urlFound) {
            Write-Error "Could not find URL. Logs:"
            if (Test-Path "pinggy.log") { Get-Content "pinggy.log" }
        }

        # 3. إبقاء الجلسة حية
        Write-Host "Session is running..."
        while ($true) {
            Start-Sleep -Seconds 60
            Write-Host -NoNewline "."
        }
