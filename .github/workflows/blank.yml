name: Win-RDP-Bore-Free

on: 
  workflow_dispatch:

jobs:
  rdp-session:
    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup User & RDP
      shell: pwsh
      run: |
        # 1. إعداد المستخدم وكلمة المرور
        $password = ConvertTo-SecureString "Admin@12345" -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $password

        # 2. تفعيل RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -value 1
        Set-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System' -Name "InactivityTimeoutSecs" -Value 0 -Force

    - name: Start Bore Tunnel
      shell: pwsh
      run: |
        Write-Host "Downloading Bore..."
        # تحميل الأداة (حجمها صغير جداً)
        Invoke-WebRequest "https://github.com/justin/bore/releases/download/v0.5.2/bore-v0.5.2-x86_64-pc-windows-msvc.zip" -OutFile "bore.zip"
        Expand-Archive bore.zip -DestinationPath .
        
        Write-Host "Starting Tunnel..."
        # تشغيل النفق وربط بورت 3389 (RDP) بالسيرفر العام
        # يتم حفظ المخرجات في ملف لاستخراج الرابط منه
        $proc = Start-Process -FilePath ".\bore.exe" -ArgumentList "local 3389 --to bore.pub" -PassThru -RedirectStandardOutput "bore_log.txt"
        
        # الانتظار 5 ثواني لضمان الاتصال
        Start-Sleep -Seconds 5
        
        # قراءة الملف واستخراج البورت
        $logContent = Get-Content "bore_log.txt"
        
        Write-Host "==========================================" -ForegroundColor Green
        
        if ($logContent -match "listening at") {
            # استخراج البورت من النص
            $port = $logContent | Select-String -Pattern "bore.pub:(\d+)" | ForEach-Object { $_.Matches.Groups[1].Value }
            
            if ($port) {
                Write-Host "YOUR RDP ADDRESS IS:" -ForegroundColor Cyan
                Write-Host "bore.pub:$port" -ForegroundColor Yellow
            } else {
                Write-Host "Connected but could not parse port. Check logs below." -ForegroundColor Red
                Get-Content "bore_log.txt"
            }
        } else {
            Write-Host "Retrying to read logs..." -ForegroundColor Red
            Get-Content "bore_log.txt"
        }
        
        Write-Host "User: runneradmin"
        Write-Host "Pass: Admin@12345"
        Write-Host "=========================================="

    - name: Keep Alive
      shell: pwsh
      run: |
        while ($true) {
          Start-Sleep -Seconds 300
        }
