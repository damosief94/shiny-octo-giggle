name: Win-CF-Job

on:
  workflow_dispatch:

jobs:
  rdp-session:
    runs-on: windows-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    # 1. إعداد وتفعيل RDP
    - name: Enable Remote Desktop
      shell: pwsh
      run: |
        Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" fDenyTSConnections 0
        New-NetFirewallRule -DisplayName "Allow RDP" -Direction Inbound -LocalPort 3389 -Protocol TCP -Action Allow
        Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" UserAuthentication 1
        $password = ConvertTo-SecureString "Admin@12345" -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $password

    # 2. تشغيل Cloudflare باستخدام Start-Job (الحل الجذري)
    - name: Start Cloudflare Tunnel
      shell: pwsh
      run: |
        # تحميل الأداة
        Invoke-WebRequest https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe
        
        # إنشاء وظيفة في الخلفية لتشغيل النفق
        # نستخدم --no-autoupdate لمنع تأخير التحديث
        $ScriptBlock = {
            param($exePath)
            & $exePath tunnel --url tcp://localhost:3389 --no-autoupdate
        }
        
        # بدء الوظيفة
        Start-Job -ScriptBlock $ScriptBlock -ArgumentList (Convert-Path .\cloudflared.exe) -Name "CloudflareTunnel"
        
        Write-Host "Tunnel job started. Scanning output for URL..."

    # 3. استخراج الرابط من الوظيفة مباشرة
    - name: Get Connection Info
      shell: pwsh
      run: |
        $job = Get-Job -Name "CloudflareTunnel"
        $maxRetries = 100
        $retryCount = 0
        $urlFound = $false

        while ($retryCount -lt $maxRetries) {
            # استقبال البيانات الجديدة من الوظيفة دون حذفها
            $output = Receive-Job -Job $job -Keep
            
            # تحويل المخرجات إلى نص واحد للبحث
            $logContent = $output -join "`n"
            
            # البحث عن الرابط
            if ($logContent -match "tcp://[-a-zA-Z0-9.]+\.trycloudflare\.com:[0-9]+") {
                $rawUrl = $matches[0]
                $cleanUrl = $rawUrl -replace "tcp://", ""
                
                Write-Host "=============================================" -ForegroundColor Green
                Write-Host " CONNECT TO:   $cleanUrl " -ForegroundColor Yellow
                Write-Host " USERNAME:     runneradmin " -ForegroundColor Yellow
                Write-Host " PASSWORD:     Admin@12345 " -ForegroundColor Yellow
                Write-Host "=============================================" -ForegroundColor Green
                $urlFound = $true
                break
            }
            
            Write-Host "Waiting for Cloudflare URL... ($retryCount)"
            Start-Sleep -Seconds 3
            $retryCount++
        }

        if (-not $urlFound) {
            Write-Error "Could not find URL. Showing all output:"
            Receive-Job -Job $job -Keep
        }

    # 4. إبقاء الجلسة حية
    - name: Keep Session Alive
      shell: pwsh
      run: |
        Write-Host "Session is active. Press Cancel Workflow to stop."
        while ($true) {
          Start-Sleep -Seconds 300
        }
