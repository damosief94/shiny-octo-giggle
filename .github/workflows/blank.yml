name: Win-RDP-Serveo-Force

on: 
  workflow_dispatch:

jobs:
  rdp-session:
    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup User & RDP
      shell: pwsh
      run: |
        # 1. إعداد المستخدم
        $password = ConvertTo-SecureString "Admin@12345" -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $password

        # 2. تفعيل RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -value 1
        Set-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System' -Name "InactivityTimeoutSecs" -Value 0 -Force

    - name: Start Serveo Tunnel (Force TTY)
      shell: pwsh
      run: |
        Write-Host "Connecting to Serveo..."
        
        # نستخدم cmd /c لتوجيه المخرجات بشكل أقوى
        # -tt تجبر السيرفر على طباعة الرابط
        # -o StrictHostKeyChecking=no تمنع توقف السكريبت للسؤال عن البصمة
        $sshCmd = "ssh -tt -o StrictHostKeyChecking=no -R 0:localhost:3389 serveo.net"
        
        # تشغيل العملية في الخلفية وتوجيه كل المخرجات (Standard & Error) لملف واحد
        $proc = Start-Process cmd -ArgumentList "/c $sshCmd > serveo_log.txt 2>&1" -PassThru -WindowStyle Hidden
        
        # الانتظار 10 ثواني
        Start-Sleep -Seconds 10
        
        # قراءة الملف
        $logContent = Get-Content "serveo_log.txt" -ErrorAction SilentlyContinue
        
        Write-Host "==========================================" -ForegroundColor Green
        
        # البحث عن النمط الذي تطبعه Serveo عادة
        # مثال: Forwarding TCP from serveo.net:12345
        $urlMatch = $logContent | Select-String "serveo.net:[0-9]+"
        
        if ($urlMatch) {
            Write-Host "YOUR RDP ADDRESS IS:" -ForegroundColor Cyan
            # تنظيف النص لاستخراج الرابط فقط
            $cleanUrl = $urlMatch.Matches.Value
            Write-Host $cleanUrl -ForegroundColor Yellow
        } else {
            Write-Host "Could not grep URL perfectly, showing full log:" -ForegroundColor Red
            Get-Content "serveo_log.txt"
        }
        
        Write-Host "User: runneradmin"
        Write-Host "Pass: Admin@12345"
        Write-Host "=========================================="

    - name: Keep Alive
      shell: pwsh
      run: |
        while ($true) {
          Start-Sleep -Seconds 300
        }
