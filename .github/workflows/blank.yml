name: Win-Final-Hybrid

on:
  workflow_dispatch:

jobs:
  rdp-session:
    runs-on: windows-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    # 1. إعداد وتفعيل RDP
    - name: Enable Remote Desktop
      shell: pwsh
      run: |
        Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" fDenyTSConnections 0
        New-NetFirewallRule -DisplayName "Allow RDP" -Direction Inbound -LocalPort 3389 -Protocol TCP -Action Allow
        Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" UserAuthentication 1
        $password = ConvertTo-SecureString "Admin@12345" -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $password

    # 2. تشغيل الأنفاق (محاولة Cloudflare، وإذا فشل يعمل Pinggy تلقائياً)
    - name: Start Tunnel (Auto Switch)
      shell: pwsh
      run: |
        $success = $false

        # --- محاولة 1: Cloudflare ---
        Write-Host "Attempting Method 1: Cloudflare..." -ForegroundColor Cyan
        Invoke-WebRequest https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe
        
        # استخدام Start-Process مع توجيه الأخطاء لملف
        $cfProc = Start-Process -FilePath ".\cloudflared.exe" -ArgumentList "tunnel --url tcp://localhost:3389" -RedirectStandardError "cf_logs.txt" -PassThru -WindowStyle Hidden
        
        # انتظار 15 ثانية
        Start-Sleep -Seconds 15

        if (Test-Path "cf_logs.txt") {
            # قراءة الملف بطريقة آمنة
            $logs = Get-Content "cf_logs.txt" -ErrorAction SilentlyContinue
            $logString = $logs | Out-String

            # البحث عن الرابط في السجلات
            if ($logString -match "tcp://([-a-zA-Z0-9]+\.trycloudflare\.com):([0-9]+)") {
                $hostUrl = $matches[1]
                $portNum = $matches[2]
                
                Write-Host "=============================================" -ForegroundColor Green
                Write-Host " [CLOUDFLARE] SUCCESS! Tunnel is Active      " -ForegroundColor Green
                Write-Host "=============================================" -ForegroundColor Green
                Write-Host " HOST:         $hostUrl " -ForegroundColor Cyan
                Write-Host " PORT:         $portNum " -ForegroundColor Magenta
                Write-Host " USER/PASS:    runneradmin / Admin@12345 " -ForegroundColor Yellow
                Write-Host "=============================================" -ForegroundColor Green
                $success = $true
            }
        }

        # --- محاولة 2: Pinggy (البديل التلقائي) ---
        if (-not $success) {
            Write-Host "Cloudflare failed or log was empty. Switching to Method 2: Pinggy..." -ForegroundColor Red
            
            # إيقاف Cloudflare القديم إذا كان يعمل
            if ($cfProc -and -not $cfProc.HasExited) { Stop-Process -Id $cfProc.Id -Force }

            # تشغيل Pinggy
            $pinggyProc = Start-Process -FilePath "ssh" -ArgumentList "-o StrictHostKeyChecking=no -p 443 -R0:localhost:3389 tcp@a.pinggy.io" -RedirectStandardOutput "pinggy_out.txt" -RedirectStandardError "pinggy_err.txt" -PassThru -WindowStyle Hidden
            
            Start-Sleep -Seconds 10
            
            # قراءة سجلات Pinggy
            $pLogs = ""
            if (Test-Path "pinggy_out.txt") { $pLogs += Get-Content "pinggy_out.txt" -Raw }
            if (Test-Path "pinggy_err.txt") { $pLogs += Get-Content "pinggy_err.txt" -Raw }
            
            if ($pLogs -match "tcp://([a-zA-Z0-9\.-]+):([0-9]+)") {
                $hostUrl = $matches[1]
                $portNum = $matches[2]
                
                Write-Host "=============================================" -ForegroundColor Green
                Write-Host " [PINGGY] SUCCESS! Tunnel is Active          " -ForegroundColor Green
                Write-Host "=============================================" -ForegroundColor Green
                Write-Host " HOST:         $hostUrl " -ForegroundColor Cyan
                Write-Host " PORT:         $portNum " -ForegroundColor Magenta
                Write-Host " USER/PASS:    runneradmin / Admin@12345 " -ForegroundColor Yellow
                Write-Host "=============================================" -ForegroundColor Green
                $success = $true
            }
        }

        if (-not $success) {
            Write-Error "All methods failed. Please check the workflow logs."
            exit 1
        }

    # 3. إبقاء الجلسة حية
    - name: Keep Session Alive
      shell: pwsh
      run: |
        Write-Host "Session is active. Do not close this tab."
        while ($true) {
          Start-Sleep -Seconds 60
          Write-Host -NoNewline "."
        }
