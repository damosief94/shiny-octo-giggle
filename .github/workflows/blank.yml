name: Ultimate-Win-CRD

on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Download Chrome Installer
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://dl.google.com/chrome/install/latest/chrome_installer.exe" -OutFile "chrome_installer.exe"
          Start-Process -FilePath "chrome_installer.exe" -Args "/silent /install" -Wait

      - name: Download and Install CRD
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile "crd.msi"
          Start-Process -FilePath "msiexec.exe" -Args "/i crd.msi /quiet /qn" -Wait

      # ========================================================
      # Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªØ«Ø¨ÙŠØª Ø§Ù„Ø´Ø§Ø´Ø© ÙˆØ§Ù„ÙƒØ±Øª (Ù†Ø³Ø®Ø© Ù…ØµØ­Ø­Ø© 100%)
      # ========================================================
      - name: Ultimate GPU Injection (Mesa3D System-Wide)
        shell: pwsh
        run: |
          # 1. ØªØ«Ø¨ÙŠØª ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©
          Write-Host ">>> 1. Installing Virtual Display Driver..."
          # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
          Invoke-WebRequest -Uri "https://www.amyuni.com/downloads/usbmmidd_v2.zip" -OutFile "usbmmidd.zip"
          
          # ÙÙƒ Ø§Ù„Ø¶ØºØ· (Force Ù„Ù„ÙƒØªØ§Ø¨Ø© ÙÙˆÙ‚ Ø£ÙŠ Ù…Ù„ÙØ§Øª)
          Expand-Archive "usbmmidd.zip" -DestinationPath "c:\usbmmidd" -Force
          
          # Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ Ø¹Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ (Ù„Ø£Ù† Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù…ÙƒØ§Ù† Ù‚Ø¯ ÙŠØªØºÙŠØ±Ø§Ù†)
          $exePath = Get-ChildItem -Path "c:\usbmmidd" -Recurse -Filter "deviceinstaller64.exe" | Select-Object -First 1
          
          if ($exePath) {
              Set-Location -Path $exePath.DirectoryName
              Write-Host "Found installer at: $($exePath.DirectoryName)"
              & .\deviceinstaller64.exe install usbmmidd.inf usbmmidd
              & .\deviceinstaller64.exe enableidd 1
              Write-Host "âœ… Virtual Display Active."
          } else {
              Write-Error "Could not find deviceinstaller64.exe"
          }

          # 2. ØªØ­Ù…ÙŠÙ„ Mesa3D (ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø±Ø§Ø¨Ø· + Ø¥Ø¶Ø§ÙØ© UserAgent)
          Write-Host ">>> 2. Downloading Mesa3D (Fake GPU)..."
          cd C:\
          $mesaUrl = "https://github.com/pal1000/mesa-dist-win/releases/download/25.3.3/mesa3d-25.3.3-release-mingw.7z"
          
          # Ø¥Ø¶Ø§ÙØ© UserAgent Ø¶Ø±ÙˆØ±ÙŠ Ø¬Ø¯Ø§Ù‹ Ù„ØªØ¬Ù†Ø¨ Ø­Ø¸Ø± GitHub Ù„Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
          Invoke-WebRequest -Uri $mesaUrl -OutFile "mesa.7z" -UserAgent "Mozilla/5.0 (Windows NT 10.0; Win64; x64)"
          
          7z x mesa.7z -oc:\mesa3d
          $MesaDll = "C:\mesa3d\x64\opengl32.dll"

          # 3. Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù…Ù„Ù Ø§Ù„Ù†Ø¸Ø§Ù… (System32 Injection)
          Write-Host ">>> 3. Injecting Mesa3D into System32..."
          $SysDll = "C:\Windows\System32\opengl32.dll"
          
          # ÙƒØ³Ø± Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙˆÙŠÙ†Ø¯ÙˆØ² Ø¹Ù† Ù…Ù„Ù Ø§Ù„Ù†Ø¸Ø§Ù…
          takeown /f $SysDll
          icacls $SysDll /grant "${Env:USERNAME}:F"
          
          # Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ
          Rename-Item -Path $SysDll -NewName "opengl32.bak" -Force
          Copy-Item -Path $MesaDll -Destination $SysDll -Force
          
          Write-Host "âœ… FAKE GPU INSTALLED IN SYSTEM32 SUCCESSFULLY!"
      # ========================================================

      - name: Start Chrome Remote Desktop
        shell: pwsh
        env:
          CRD_CODE: ${{ secrets.CRD_CODE }}
          CRD_PIN: ${{ secrets.CRD_PIN }}
        run: |
          $exePath = "${Env:PROGRAMFILES(X86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
          & $exePath --code="$env:CRD_CODE" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name=$Env:COMPUTERNAME --pin=$env:CRD_PIN

      - name: Success Message
        shell: pwsh
        run: |
          Write-Host "======================================================"
          Write-Host "âœ… The Server is RUNNING with FAKE GPU INJECTED!"
          Write-Host "ğŸ”— Go to: https://remotedesktop.google.com/access"
          Write-Host "ğŸ‘‰ Connect to the PC named 'WIN-...' using your PIN."
          Write-Host "======================================================"

      - name: Keep Alive
        shell: pwsh
        run: |
          while ($true) { Start-Sleep -Seconds 300 }
