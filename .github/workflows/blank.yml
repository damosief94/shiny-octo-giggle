name: Win-Serveo

on:
  workflow_dispatch:

jobs:
  rdp-session:
    runs-on: windows-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    # 1. إعداد وتفعيل RDP (مع فتح الجدار الناري بشكل مؤكد)
    - name: Enable Remote Desktop
      shell: pwsh
      run: |
        Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" fDenyTSConnections 0
        # فتح المنفذ 3389 بشكل صريح في الجدار الناري
        New-NetFirewallRule -DisplayName "Allow RDP" -Direction Inbound -LocalPort 3389 -Protocol TCP -Action Allow
        Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" UserAuthentication 1
        
        # تعيين كلمة المرور
        $password = ConvertTo-SecureString "Admin@12345" -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $password

    # 2. تشغيل نفق Serveo (بديل Bore و Ngrok)
    - name: Start Serveo Tunnel
      shell: pwsh
      run: |
        # تشغيل SSH Tunnel في الخلفية وتوجيه المخرجات لملف log
        # الخيار StrictHostKeyChecking=no يمنع توقف السكربت للسؤال عن البصمة
        Start-Process ssh -ArgumentList "-o StrictHostKeyChecking=no -R 0:localhost:3389 serveo.net" -RedirectStandardOutput "serveo.log" -RedirectStandardError "serveo_err.log" -WindowStyle Hidden
        
        Write-Host "Tunnel is starting... waiting for URL..."
        Start-Sleep -Seconds 10

    # 3. جلب وطباعة رابط الاتصال
    - name: Get Connection Info
      shell: pwsh
      run: |
        try {
            # قراءة ملف السجلات لاستخراج الرابط
            # المخرج المتوقع: Forwarding TCP traffic from serveo.net:12345
            $log = Get-Content "serveo.log" -Raw
            if (-not $log) { $log = Get-Content "serveo_err.log" -Raw }
            
            if ($log -match "serveo.net:[0-9]+") {
                $url = $matches[0]
                Write-Host "=============================================" -ForegroundColor Green
                Write-Host " CONNECT TO:   $url " -ForegroundColor Yellow
                Write-Host " USERNAME:     runneradmin " -ForegroundColor Yellow
                Write-Host " PASSWORD:     Admin@12345 " -ForegroundColor Yellow
                Write-Host "=============================================" -ForegroundColor Green
            } else {
                Write-Error "Could not find URL yet. Retrying..."
                Start-Sleep -Seconds 5
                $log = Get-Content "serveo.log" -Raw
                if ($log -match "serveo.net:[0-9]+") {
                     $url = $matches[0]
                     Write-Host "=============================================" -ForegroundColor Green
                     Write-Host " CONNECT TO:   $url " -ForegroundColor Yellow
                     Write-Host "=============================================" -ForegroundColor Green
                } else {
                     Write-Error "Check logs below:"
                     Get-Content "serveo.log"
                     Get-Content "serveo_err.log"
                }
            }
        } catch {
            Write-Error "Error reading connection logs."
        }

    # 4. إبقاء الجلسة حية
    - name: Keep Session Alive
      shell: pwsh
      run: |
        Write-Host "Session is active. Press Cancel Workflow to stop."
        while ($true) {
          Start-Sleep -Seconds 300
        }
