name: Win-RDP-Zrok-Smart

on: 
  workflow_dispatch:

jobs:
  zrok-session:
    runs-on: windows-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup User & RDP Configuration
      shell: pwsh
      run: |
        $password = ConvertTo-SecureString "Admin@12345" -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $password
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -value 1
        Set-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System' -Name "InactivityTimeoutSecs" -Value 0 -Force

    - name: Install & Configure Zrok (Smart Download)
      shell: pwsh
      env:
        ZROK_TOKEN: ${{ secrets.ZROK_TOKEN }}
      run: |
        Write-Host "Fetching latest release info..."
        
        # 1. جلب بيانات أحدث إصدار من GitHub API
        $latest = Invoke-RestMethod -Uri "https://api.github.com/repos/openziti/zrok/releases/latest"
        
        # 2. البحث داخل قائمة الملفات (Assets) عن الملف الخاص بالويندوز
        # نبحث عن أي ملف ينتهي بـ windows_amd64.zip
        $asset = $latest.assets | Where-Object { $_.name -like "*windows_amd64.zip" } | Select-Object -First 1
        
        if ($null -eq $asset) {
            Write-Error "Could not find a Windows asset in the latest release!"
            exit 1
        }

        $downloadUrl = $asset.browser_download_url
        Write-Host "Found Asset: $($asset.name)"
        Write-Host "Downloading from: $downloadUrl"
        
        # 3. التحميل باستخدام الرابط المباشر المستخرج
        Invoke-WebRequest $downloadUrl -OutFile "zrok.zip"
        
        # 4. فك الضغط والتثبيت
        Expand-Archive zrok.zip -DestinationPath .
        
        # البحث عن ملف zrok.exe ونقله
        $zrokPath = Get-ChildItem -Path . -Recurse -Filter "zrok.exe" | Select-Object -First 1
        Move-Item -Path $zrokPath.FullName -Destination "$env:USERPROFILE\zrok.exe"
        
        # تفعيل الحساب
        & "$env:USERPROFILE\zrok.exe" enable $env:ZROK_TOKEN
        Write-Host "Zrok Enabled Successfully!"

    - name: Start Zrok Tunnel & Show Link
      shell: pwsh
      run: |
        Write-Host "Starting Zrok Tunnel..."
        $proc = Start-Process -FilePath "$env:USERPROFILE\zrok.exe" -ArgumentList "share public 127.0.0.1:3389 --backend-mode tcpTunnel --headless" -PassThru -RedirectStandardOutput "$env:USERPROFILE\zrok_log.txt"
        
        Start-Sleep -Seconds 15
        
        $logContent = Get-Content "$env:USERPROFILE\zrok_log.txt"
        $urlLine = $logContent | Select-String "tcp://"
        
        Write-Host "=============================================" -ForegroundColor Green
        if ($urlLine) {
            Write-Host "YOUR RDP ADDRESS IS:" -ForegroundColor Cyan
            $cleanUrl = $urlLine.ToString().Split(" ")[-1]
            Write-Host $cleanUrl -ForegroundColor Yellow
        } else {
            Write-Host "Wait a bit more or check logs..." -ForegroundColor Red
            Get-Content "$env:USERPROFILE\zrok_log.txt"
        }
        Write-Host "User: runneradmin"
        Write-Host "Pass: Admin@12345"
        Write-Host "============================================="

    - name: Keep Alive
      shell: pwsh
      run: |
        while ($true) {
          Start-Sleep -Seconds 300
        }
