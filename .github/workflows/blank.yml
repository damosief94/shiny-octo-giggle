name: Win-RDP-Pinggy-Final

on: 
  workflow_dispatch:

jobs:
  rdp-session:
    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup User & RDP
      shell: pwsh
      run: |
        # 1. إعداد المستخدم وكلمة المرور
        $password = ConvertTo-SecureString "Admin@12345" -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $password

        # 2. تفعيل RDP والجدار الناري
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -value 1
        Set-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System' -Name "InactivityTimeoutSecs" -Value 0 -Force

    - name: Start Pinggy Tunnel
      shell: pwsh
      run: |
        Write-Host "Connecting to Pinggy..."
        
        # تشغيل SSH Tunnel في الخلفية وحفظ المخرجات في ملف
        # نستخدم tcp@a.pinggy.io للحصول على رابط TCP مباشر
        $proc = Start-Process -FilePath "ssh" -ArgumentList "-o StrictHostKeyChecking=no -p 443 -R0:localhost:3389 tcp@a.pinggy.io" -PassThru -RedirectStandardOutput "pinggy_log.txt" -RedirectStandardError "pinggy_error.txt" -WindowStyle Hidden
        
        # الانتظار 10 ثواني لضمان إنشاء الرابط
        Start-Sleep -Seconds 10
        
        # قراءة الملف واستخراج الرابط
        $logContent = Get-Content "pinggy_log.txt" -ErrorAction SilentlyContinue
        
        Write-Host "==========================================" -ForegroundColor Green
        
        # البحث عن الرابط داخل السطور
        $urlLine = $logContent | Select-String "tcp://"
        
        if ($urlLine) {
            Write-Host "YOUR RDP ADDRESS IS:" -ForegroundColor Cyan
            # تنظيف الرابط ليظهر بشكل نظيف
            $cleanUrl = $urlLine.ToString() -replace ".*(tcp://.*)", '$1'
            Write-Host $cleanUrl -ForegroundColor Yellow
        } else {
            Write-Host "URL not found immediately. Checking raw output:" -ForegroundColor Red
            Get-Content "pinggy_log.txt"
            Get-Content "pinggy_error.txt"
        }
        
        Write-Host "User: runneradmin"
        Write-Host "Pass: Admin@12345"
        Write-Host "=========================================="

    - name: Keep Alive
      shell: pwsh
      run: |
        while ($true) {
          Start-Sleep -Seconds 300
        }
